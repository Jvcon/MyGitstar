name: 01 - Fetch and Analyze Stars

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
  workflow_dispatch: 
    inputs:
      mode: 
        description: 'Run mode'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - release
  # schedule:
  #   - cron: '0 0 * * 0' # 每周日午夜执行一次

jobs:
  fetch:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.auto-commit-action.outputs.changes_detected || 'false'}}
      mode: ${{ steps.init-env.outputs.mode }}
    steps:
      - name: Initialize environment
        id: init-env
        run: |
          if [ "${{ github.event_name}}" == 'push' ]; then
            echo "mode=draft" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == 'schedule' ]; then
            echo "mode=release" >> $GITHUB_OUTPUT
          else
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          fi
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies and run
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          python scripts/fetch_stars.py

      - name: Upload stars file
        if: steps.init-env.outputs.mode == 'draft'
        uses: actions/upload-artifact@v4
        with:
          name: my-stars-draft
          path: |
            my-stars.md
            my-stars.csv

      - name: Prepare release files
        if: steps.init-env.outputs.mode == 'release'
        run: |
          mkdir -p app/src/content/docs app/public/data
          mv my-stars.md app/src/content/docs/index.md
          mv my-stars.csv app/public/data/my-stars.csv

      - name: Commit and push release changes
        id: auto-commit-action
        if: steps.init-env.outputs.mode == 'release'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📚 Release update of starred repositories"
          file_pattern: 'app/src/content/docs/index.md app/public/data/my-stars.csv'
          branch: main

  call-build:
    if: needs.fetch.outputs.has_changes == 'true'
    uses: ./.github/workflows/02-build.yml
    with:
      mode: ${{ needs.fetch.outputs.mode }}
    needs: fetch
