name: 01 - Fetch and Analyze Stars

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
  workflow_dispatch: 
    inputs:
      mode: 
        description: 'Run mode'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - release
  # schedule:
  #   - cron: '0 0 * * 0' # æ¯å‘¨æ—¥åˆå¤œæ‰§è¡Œä¸€æ¬¡
env:
  BACKEND_PATH: "./scripts"
  FRONTEND_PATH: "./app"

jobs:
  fetch:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.auto-commit-action.outputs.changes_detected || 'false'}}
      mode: ${{ steps.init-env.outputs.mode }}
    steps:
      - name: Initialize environment
        id: init-env
        run: |
          if [ "${{ github.event_name}}" == 'push' ]; then
            echo "mode=draft" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == 'schedule' ]; then
            echo "mode=release" >> $GITHUB_OUTPUT
          else
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_OUTPUT
          fi
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies and run
        id: fetch-stars
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        working-directory: ${{ env.BACKEND_PATH }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python fetch_stars.py
          echo "path=${{env.BACKEND_PATH}}/dist" >> $GITHUB_OUTPUT

      - name: Upload stars file
        if: steps.init-env.outputs.mode == 'draft'
        uses: actions/upload-artifact@v4
        with:
          name: my-stars-draft
          path: ${{ steps.fetch-stars.outputs.path }}
          retention-days: 7

      - name: Prepare release files
        if: steps.init-env.outputs.mode == 'release'
        run: |
          mkdir -p ${{env.FRONTEND_PATH}}/src/content/docs
          mv ${{ steps.fetch-stars.outputs.path }}/*.md ${{env.FRONTEND_PATH}}/src/content/docs/
          mv ${{ steps.fetch-stars.outputs.path }}/*.csv ${{env.FRONTEND_PATH}}/src/content/
          mv ${{ steps.fetch-stars.outputs.path }}/*.json ${{env.FRONTEND_PATH}}/src/content/

      - name: Commit and push release changes
        id: auto-commit-action
        if: steps.init-env.outputs.mode == 'release'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ“š Release update of starred repositories"
          file_pattern: '${{env.FRONTEND_PATH}}/src/content/*'
          branch: main

  call-build:
    if: ${{needs.fetch.outputs.has_changes}}
    uses: ./.github/workflows/02-build.yml
    with:
      mode: ${{ needs.fetch.outputs.mode }}
      has_changes: true
    needs: fetch
